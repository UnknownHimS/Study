<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sci-Fi Notes Editor</title>

<style>
body {
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #0d1117;
  color: #c9d1d9;
}

button {
  background-color: #21262d;
  color: #c9d1d9;
  border: 1px solid #30363d;
  padding: 6px 12px;
  cursor: pointer;
  border-radius: 4px;
  margin: 2px;
  transition: background-color 0.2s ease;
}

button:hover {
  background-color: #30363d;
}

input[type="file"] {
  display: none;
}

#openEditorBtn,
#aboutBtn {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 30px auto;
  padding: 14px 24px;
  font-size: 1.2em;
}

/* === Editor Layout === */
#editorSection {
  display: none;
  flex-direction: column;
  padding: 20px;
  max-width: 900px;
  margin: 0 auto;
  background-color: #161b22;
  border-radius: 8px;
}

#editorSection.active {
  display: flex;
}

#editor {
  background-color: #0d1117;
  border: 1px solid #30363d;
  min-height: 400px;
  padding: 15px;
  border-radius: 6px;
  margin-top: 10px;
  color: #c9d1d9;
  overflow: auto;
}

#editor:focus {
  outline: 2px solid #3f51b5;
}

.toolbar {
  display: flex;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

/* === Media Wrapper === */
.media-wrapper {
  position: relative;
  display: inline-block;
  margin: 10px 0;
  padding: 5px;
  border: 1px dashed #3f51b5;
  border-radius: 4px;
  resize: both;
  overflow: auto;
  cursor: move;
  background-color: #1f2937;
}

.media-wrapper img,
.media-wrapper video,
.media-wrapper iframe {
  max-width: 100%;
  height: auto;
  display: block;
  pointer-events: auto;
}

/* === Delete Button === */
.media-wrapper .delete-btn {
  position: absolute;
  top: -10px;
  right: -10px;
  background: crimson;
  color: white;
  border: none;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 12px;
  cursor: pointer;
  z-index: 10;
}

/* === Notes List === */
#savedNotesList {
  margin-top: 20px;
  border-top: 1px solid #30363d;
  padding-top: 10px;
}

.noteItem {
  padding: 8px 12px;
  margin-bottom: 5px;
  border: 1px solid #3f51b5;
  border-radius: 4px;
  background-color: #1a1f2c;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.noteItem:hover {
  background-color: #2a3250;
}

.noteItem.active {
  background-color: #3f51b5;
  color: #fff;
  font-weight: bold;
}

/* === Modal Preview === */
#previewModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(13, 17, 23, 0.95);
  justify-content: center;
  align-items: center;
  z-index: 999;
}

#previewBody {
  background-color: #0d1117;
  padding: 20px;
  max-width: 90%;
  max-height: 90%;
  overflow: auto;
  border: 1px solid #30363d;
  border-radius: 8px;
  color: #c9d1d9;
}

#previewClose {
  position: absolute;
  top: 20px;
  right: 30px;
  background-color: crimson;
  color: white;
  font-size: 20px;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
}

/* === Responsive === */
@media (max-width: 768px) {
  #editorSection {
    padding: 10px;
  }

  .toolbar {
    flex-direction: column;
  }

  button {
    width: 100%;
    margin: 5px 0;
  }

  .media-wrapper {
    width: 100% !important;
    max-width: 100%;
  }
}
</style>
</head>
<body>

<!-- Top Toolbar Buttons -->
<div id="topButtons">
  <button id="openEditorBtn" class="toolbarBtn" title="Open Sci-Fi Editor" aria-label="Open Sci-Fi Editor">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M4 5h16v2H4V5zm0 6h16v2H4v-2zm0 6h16v2H4v-2z"/>
    </svg>
    Sci-Fi Notes
  </button>
  <a href="https://unknownhims.github.io/TaskList/" id="aboutBtn" class="toolbarBtn" title="Task List" aria-label="About link button" style="text-decoration:none;">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M3.9 12a5 5 0 0 1 5-5h3v2H8.9a3 3 0 0 0 0 6h3v2h-3a5 5 0 0 1-5-5zm11.2-3h-3v2h3a3 3 0 0 1 0 6h-3v2h3a5 5 0 0 0 0-10z"/>
    </svg>
    Task List
  </a>
</div>

<div id="container">
  <!-- Editor -->
  <section id="editorSection" aria-label="Editor Section">
    <div id="editorToolbar" role="toolbar" aria-label="Editor toolbar">
      <button type="button" id="boldBtn" title="Bold (Ctrl+B)" aria-label="Bold"><b>B</b></button>
      <button type="button" id="italicBtn" title="Italic (Ctrl+I)" aria-label="Italic"><i>I</i></button>
      <button type="button" id="underlineBtn" title="Underline (Ctrl+U)" aria-label="Underline"><u>U</u></button>
      <button type="button" id="insertImageBtn" title="Insert Image (File)" aria-label="Insert Image from file">üñºÔ∏è</button>
      <input type="file" id="imageInput" accept="image/*" />
      <button type="button" id="insertVideoBtn" title="Insert Video (File)" aria-label="Insert Video from file">üé•</button>
      <input type="file" id="videoInput" accept="video/*" />
      <button type="button" id="insertImageUrlBtn" title="Insert Image via URL" aria-label="Insert Image via URL">üåêüñºÔ∏è</button>
      <button type="button" id="insertVideoUrlBtn" title="Insert Video via URL" aria-label="Insert Video via URL">üåêüé•</button>
      <button type="button" id="insertPdfUrlBtn" title="Insert PDF via URL" aria-label="Insert PDF via URL">üåêüìÑ</button>
      <button type="button" id="saveBtn" title="Save Note" aria-label="Save Note">üíæ Save</button>
      <button type="button" id="savePdfBtn" title="Save as PDF" aria-label="Save as PDF">üìÑ Save PDF</button>
      <button type="button" id="previewBtn" title="Preview Note" aria-label="Preview Note">üëÅÔ∏è Preview</button>
      <button type="button" id="closeEditorBtn" title="Close Editor" aria-label="Close Editor" style="margin-left:auto; background:#3f51b5;">‚úñÔ∏è Close</button>
    </div>
    <div id="editor" contenteditable="true" spellcheck="false" aria-label="Editable content area" tabindex="0">
      <p>Start writing your sci-fi notes here...</p>
    </div>
  </section>

  <!-- Storage Panel -->
  <aside id="storagePanel" aria-label="Saved notes storage panel">
    <h2>Storage Room</h2>
    <div id="savedNotesList" role="list" aria-live="polite" aria-relevant="additions removals"></div>
  </aside>
</div>

<!-- Preview Modal -->
<div id="previewModal" role="dialog" aria-modal="true" aria-labelledby="previewTitle">
  <div id="previewContent">
    <button id="previewClose" aria-label="Close Preview">Close ‚úñÔ∏è</button>
    <div id="previewBody"></div>
  </div>
</div>

<!-- Libraries for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  const { jsPDF } = window.jspdf;

  // Elements
  const openEditorBtn = document.getElementById('openEditorBtn');
  const aboutBtn = document.getElementById('aboutBtn');
  const editorSection = document.getElementById('editorSection');
  const editor = document.getElementById('editor');
  const savedNotesList = document.getElementById('savedNotesList');
  const saveBtn = document.getElementById('saveBtn');
  const previewBtn = document.getElementById('previewBtn');
  const closeEditorBtn = document.getElementById('closeEditorBtn');
  const previewModal = document.getElementById('previewModal');
  const previewClose = document.getElementById('previewClose');
  const previewBody = document.getElementById('previewBody');
  const savePdfBtn = document.getElementById('savePdfBtn');

  const insertImageBtn = document.getElementById('insertImageBtn');
  const insertVideoBtn = document.getElementById('insertVideoBtn');
  const insertImageUrlBtn = document.getElementById('insertImageUrlBtn');
  const insertVideoUrlBtn = document.getElementById('insertVideoUrlBtn');
  const insertPdfUrlBtn = document.getElementById('insertPdfUrlBtn');

  const imageInput = document.getElementById('imageInput');
  const videoInput = document.getElementById('videoInput');

  let currentNoteId = null;

  // --- Editor open / close ---
  openEditorBtn.addEventListener('click', () => {
    editorSection.classList.add('active');
    aboutBtn.style.display = 'none';
    openEditorBtn.style.display = 'none';
    if (!editor.innerHTML.trim()) {
      editor.innerHTML = '<p>Start writing your sci-fi notes here...</p>';
    }
  });

  closeEditorBtn.addEventListener('click', () => {
    editorSection.classList.remove('active');
    openEditorBtn.style.display = 'flex';
    aboutBtn.style.display = 'flex';
    deselectAllNotes();
    currentNoteId = null;
    clearEditor();
  });

  aboutBtn.addEventListener('click', () => {
    window.open('https://unknownhims.github.io/eyy/', '_blank', 'noopener');
  });

  // --- Text formatting buttons ---
  document.getElementById('boldBtn').addEventListener('click', () => document.execCommand('bold'));
  document.getElementById('italicBtn').addEventListener('click', () => document.execCommand('italic'));
  document.getElementById('underlineBtn').addEventListener('click', () => document.execCommand('underline'));

  // --- Insert image from file ---
  insertImageBtn.addEventListener('click', () => imageInput.click());
  imageInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = ev => insertImage(ev.target.result);
      reader.readAsDataURL(file);
    }
    imageInput.value = '';
  });

  // --- Insert video from file ---
  insertVideoBtn.addEventListener('click', () => videoInput.click());
  videoInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = ev => insertVideo(ev.target.result);
      reader.readAsDataURL(file);
    }
    videoInput.value = '';
  });

  // --- Insert via URL ---
  insertImageUrlBtn.addEventListener('click', () => {
    const url = prompt('Enter image URL:');
    if (url) insertImage(url);
  });

  insertVideoUrlBtn.addEventListener('click', () => {
    const url = prompt('Enter video URL (MP4/WebM):');
    if (url) insertVideo(url);
  });

  insertPdfUrlBtn.addEventListener('click', () => {
    const url = prompt('Enter PDF URL:');
    if (url) {
      const html = createMediaWrapper(`<iframe src="${url}" title="Embedded PDF"></iframe>`);
      insertAtCursor(html);
    }
  });

  // --- Functions to insert with wrapper ---
  function insertImage(src) {
    const html = createMediaWrapper(`<img src="${src}" alt="Inserted image">`);
    insertAtCursor(html);
  }

  function insertVideo(src) {
    const html = createMediaWrapper(`<video controls src="${src}"></video>`);
    insertAtCursor(html);
  }

  function createMediaWrapper(innerHTML) {
    // wrapper containing media + delete button; non-editable (so text editing around it is safe)
    const wrapper = document.createElement('div');
    wrapper.className = 'media-wrapper';
    wrapper.setAttribute('contenteditable', 'false');
    wrapper.setAttribute('draggable', 'true');
    wrapper.style.position = 'relative';
    wrapper.innerHTML = `
      <button class="delete-btn" aria-label="Delete media" title="Delete media">‚úñ</button>
      ${innerHTML}
    `;

    // Delete handler
    wrapper.querySelector('.delete-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      const w = e.target.parentElement;
      if (w && w.parentElement) {
        w.parentElement.removeChild(w);
      }
    });

    // Add dragging functionality
    addDragHandlers(wrapper);

    return wrapper.outerHTML;
  }

  function insertAtCursor(html) {
    editor.focus();
    const sel = window.getSelection();
    if (!sel || !sel.rangeCount) {
      editor.innerHTML += html;
      return;
    }
    const range = sel.getRangeAt(0);
    range.deleteContents();
    const el = document.createElement('div');
    el.innerHTML = html;
    const frag = document.createDocumentFragment();
    let node, lastNode;
    while ((node = el.firstChild)) {
      lastNode = frag.appendChild(node);
    }
    range.insertNode(frag);
    if (lastNode) {
      range.setStartAfter(lastNode);
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);
    }
    editor.focus();
  }

  // --- Drag & Drop Move support ---
  let dragSrcEl = null;

  function addDragHandlers(elem) {
    elem.addEventListener('dragstart', dragStartHandler);
    elem.addEventListener('dragover', dragOverHandler);
    elem.addEventListener('drop', dropHandler);
    elem.addEventListener('dragend', dragEndHandler);
  }

  function dragStartHandler(e) {
    const target = e.target.closest('.media-wrapper');
    if (!target) return;
    dragSrcEl = target;
    e.dataTransfer.effectAllowed = 'move';
    // Save the HTML of the dragged element
    e.dataTransfer.setData('text/html', target.outerHTML);
    // Make dragged invisible temporarily
    setTimeout(() => {
      target.style.display = 'none';
    }, 0);
  }

  function dragOverHandler(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  }

  function dropHandler(e) {
    e.preventDefault();
    const target = e.target.closest('.media-wrapper');
    // drop into editor: find caret position from point
    if (dragSrcEl) {
      // restore the dragged element removed
      dragSrcEl.style.display = 'inline-block';
      // Remove the original
      dragSrcEl.remove();
      const dropHTML = e.dataTransfer.getData('text/html');
      // Insert at drop point
      const range = document.caretRangeFromPoint
        ? document.caretRangeFromPoint(e.clientX, e.clientY)
        : (document.caretPositionFromPoint
            ? document.caretPositionFromPoint(e.clientX, e.clientY).range
            : null);
      if (range) {
        range.insertNode(document.createRange().createContextualFragment(dropHTML));
      } else {
        // fallback
        editor.appendChild(document.createRange().createContextualFragment(dropHTML));
      }
      // Re-bind handlers on newly inserted wrapper elements
      rebindMediaWrappers();
      dragSrcEl = null;
    }
  }

  function dragEndHandler(e) {
    if (dragSrcEl) {
      dragSrcEl.style.display = 'inline-block';
      dragSrcEl = null;
    }
  }

  function rebindMediaWrappers() {
    const wrappers = editor.querySelectorAll('.media-wrapper');
    wrappers.forEach(w => {
      // ensure delete button is bound
      const del = w.querySelector('.delete-btn');
      if (del && !del.hasListener) {
        del.addEventListener('click', (e) => {
          e.stopPropagation();
          const wrr = e.target.parentElement;
          if (wrr && wrr.parentElement) {
            wrr.parentElement.removeChild(wrr);
          }
        });
        del.hasListener = true;
      }
      // ensure drag handlers
      if (!w.hasAttribute('data-drag-bound')) {
        addDragHandlers(w);
        w.setAttribute('data-drag-bound', 'true');
      }
    });
  }

  // --- Save / Load notes ---
  saveBtn.addEventListener('click', () => {
    const content = editor.innerHTML.trim();
    if (!content || content === '<p>Start writing your sci-fi notes here...</p>') {
      alert('Cannot save empty note.');
      return;
    }
    if (currentNoteId) {
      localStorage.setItem(currentNoteId, content);
      alert('Note updated!');
    } else {
      const id = Date.now().toString();
      localStorage.setItem(id, content);
      currentNoteId = id;
      alert('Note saved!');
    }
    loadSavedNotes();
    highlightNote(currentNoteId);
  });

  function loadSavedNotes() {
    savedNotesList.innerHTML = '';
    const keys = Object.keys(localStorage)
      .filter(k => !isNaN(k))
      .sort((a, b) => b - a);
    if (keys.length === 0) {
      savedNotesList.innerHTML = '<p style="color:#7986cb; text-align:center;">No saved notes yet.</p>';
      return;
    }
    keys.forEach(id => {
      const note = localStorage.getItem(id);
      const div = document.createElement('div');
      div.className = 'noteItem';
      div.tabIndex = 0;
      div.role = 'listitem';
      div.title = 'Click to load this note';
      div.innerHTML = summarizeContent(note);
      div.dataset.id = id;
      div.addEventListener('click', () => loadNote(id));
      div.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          loadNote(id);
        }
      });
      savedNotesList.appendChild(div);
    });
  }

  function highlightNote(id) {
    const items = document.querySelectorAll('.noteItem');
    items.forEach(i => i.classList.toggle('active', i.dataset.id === id));
  }

  function deselectAllNotes() {
    const items = document.querySelectorAll('.noteItem');
    items.forEach(i => i.classList.remove('active'));
  }

  function loadNote(id) {
    const content = localStorage.getItem(id);
    if (content) {
      editor.innerHTML = content;
      currentNoteId = id;
      highlightNote(id);
      editorSection.classList.add('active');
      openEditorBtn.style.display = 'none';
    }
    // After loading, rebind wrappers
    setTimeout(() => rebindMediaWrappers(), 0);
  }

  function clearEditor() {
    editor.innerHTML = '<p>Start writing your sci-fi notes here...</p>';
  }

  function summarizeContent(html) {
    const div = document.createElement('div');
    div.innerHTML = html;
    const text = div.textContent || div.innerText || '';
    if (text.length > 60) return text.slice(0, 57) + '...';
    if (text.length) return text;
    if (html.includes('<img')) return '[Image Note]';
    if (html.includes('<video')) return '[Video Note]';
    if (html.includes('<iframe')) return '[PDF Note]';
    return '[Empty Note]';
  }

  // --- Preview Note ---
  previewBtn.addEventListener('click', () => {
    previewBody.innerHTML = editor.innerHTML;
    previewModal.style.display = 'flex';
  });

  previewClose.addEventListener('click', () => {
    previewModal.style.display = 'none';
  });

  previewModal.addEventListener('click', e => {
    if (e.target === previewModal) {
      previewModal.style.display = 'none';
    }
  });

  // --- Keyboard shortcuts for bold/italic/underline ---
  editor.addEventListener('keydown', e => {
    if (e.ctrlKey) {
      switch (e.key.toLowerCase()) {
        case 'b':
          e.preventDefault();
          document.execCommand('bold');
          break;
        case 'i':
          e.preventDefault();
          document.execCommand('italic');
          break;
        case 'u':
          e.preventDefault();
          document.execCommand('underline');
          break;
      }
    }
  });

  // --- Save as PDF ---
  savePdfBtn.addEventListener('click', async () => {
    alert('Generating PDF, please wait...');
    const element = editor;
    const scale = 2;
    const canvas = await html2canvas(element, {
      scale: scale,
      useCORS: true,
      logging: false,
      backgroundColor: '#12162b'
    });
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'pt',
      format: [canvas.width * 72 / 96, canvas.height * 72 / 96] 
    });
    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width * 72 / 96, canvas.height * 72 / 96);
    const filename = `SciFiNote_${new Date().toISOString().replace(/[:.]/g,'-')}.pdf`;
    pdf.save(filename);
  });

  // On load
  loadSavedNotes();

</script>

</body>
</html>
