<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>Study Tool with Toolbar</title>
  <link rel="icon" type="image/png" href="https://i.pinimg.com/originals/3e/e7/87/3ee78760d85467a2819be0d1ae677655.png" />

  <style>
     @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');
    
    * {
      margin: 0; padding: 0; box-sizing: border-box;
    }
    body, html {
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:black;
      background-size: cover;
      overflow: hidden;
    }
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 10px;
      margin-right: 40px; /* leave space for sidebar */
    }
    #pdf-container {
      resize: both;
      overflow: auto;
      border: 2px solid #ccc;
      border-radius: 8px;
      background: white;
      min-height: 50px;
      min-width: 200px;
      max-height: 90vh;
      max-width: 95vw;
      padding: 0;
    }
    
    iframe#mediaViewer {
      border: none;
      width: 100%;
      height: 100%;
      display: block;
    }


    textarea {
        width: 100%;           
        height: 90vh;
        resize: both;    
        margin-top: 10px;
        border-radius: 8px;
        padding: 10px;
        font-size: 1em;
        background: rgba(255, 255, 255, 0.9);
        border: none;
      }


    #drawCanvas {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
      pointer-events: none;
    }
    .drawing-enabled #drawCanvas {
      pointer-events: all;
    }

    /* Right sidebar */
    #sidebar {
      position: fixed;
      top: 10vh;
      right: 10px;
      width: 45px;
      background: rgba(255,255,255,0.9);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 5px 0;
      z-index: 10;
      user-select: none;
    }
    #sidebar button {
      background: none;
      border: none;
      margin: 8px 0;
      cursor: pointer;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: background-color 0.2s ease;
      color: #333;
    }
    #sidebar button:hover, #sidebar button.active {
      background-color: #4caf50;
      color: white;
    }
    #sidebar button svg {
      width: 24px;
      height: 24px;
      pointer-events: none;
    }

    /* Uploaded images */
    img.uploaded-img {
      position: absolute;
     
      cursor: move;
      z-index: 4;
      user-select: none;
    
     
      
      transition: box-shadow 0.2s ease;
    }
    img.uploaded-img.selected {
      outline: 3px solid #4caf50;
      box-shadow: 0 0 10px #4caf50;
      cursor: move;
    }

    /* Resize handle styling */
    .resize-handle {
      position: absolute;
      width: 12px;
      height: 12px;
      background: #4caf50;
      border-radius: 50%;
      right: 0;
      bottom: 0;
      cursor: se-resize;
      user-select: none;
      z-index: 10;
      box-shadow: 0 0 5px #4caf50;
      display: none;
    }

    /* Timer (floating top-left) */
    #timer-btn {
      position: fixed;
      right: 1px;
      top: 20px;
      background-color: rgba(255,255,255,0.8);
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      z-index: 6;
      font-size: 1em;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    #timer-popup {
      position: fixed;
      right:1px;
      top: 70px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 999;
      display: none;
      width: 170px;
      font-size: 0.9em;
      user-select: none;
    }
    #timer-popup label {
      display: block;
      margin-bottom: 5px;
    }
    #timer-popup input {
      width: 50px;
      margin-right: 5px;
      text-align: center;
      font-size: 1em;
      padding: 3px;
    }
    #timer-popup button {
      margin-top: 8px;
      width: 100%;
      padding: 7px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      user-select: none;
    }
    #timer-popup button:not(:last-child) {
      margin-bottom: 5px;
    }
    #countdown-display {
      font-size: 1.4em;
      margin-top: 10px;
      text-align: center;
      font-weight: bold;
      color: #4caf50;
    }
   
    

    #wiki-assistant-toggle {
      position: fixed;
      top: 20px;
      right: 30px;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 10px;
      z-index: 10000;
    }
    #wiki-assistant-toggle svg {
      width: 26px;
      height: 26px;
      stroke: white;
      transition: transform 0.2s;
    }
    #wiki-assistant-toggle:hover svg {
      transform: scale(1.2);
    }

    #wiki-assistant {
      display: none;
      position: fixed;
      top: 80px;
      right: 30px;
      width: 360px;
      height: 500px;
      background: #25254b;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
      z-index: 9999;
      cursor: move;
      resize: both;
      overflow: auto;
      min-width: 300px;
      min-height: 200px;
      max-width: 800px;
      max-height: 600px;
    }

    #wiki-assistant h3 {
      margin-top: 0;
      font-size: 1.5rem;
      text-align: center;
      color: #f5f5f5;
      user-select: none;
      cursor: default;
    }

    #wiki-assistant #status {
      font-size: 1rem;
      margin-bottom: 10px;
      color: #a3a3f7;
    }

    #wiki-assistant button {
      margin: 5px 6px;
      padding: 10px 16px;
      font-size: 0.95rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #3a3a6e;
      color: #f5f5f5;
      transition: background 0.3s;
    }

    #wiki-assistant button:hover {
      background: #5050a5;
    }

    #wiki-assistant #results {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }

    #wiki-assistant #results button {
      width: 100%;
      text-align: left;
      margin-top: 6px;
    }
  </style>
</head>
<body>
 
  <!-- Timer Button + Popup -->
  <button id="timer-btn" title="Toggle Timer Panel">‚è± Timer</button>
  <div id="timer-popup" role="region" aria-label="Timer Controls">
    <label for="minutes">Set Time (minutes):</label>
    <input type="number" id="minutes" min="1" value="20" />
    <div id="countdown-display" aria-live="polite">20:00</div>
    <button id="start-timer">Start</button>
    <button id="pause-timer">Pause</button>
    <button id="reset-timer">Reset</button>
  </div>

  
  <div id="app">
    <div id="pdf-container">
      <iframe id="mediaViewer" allowfullscreen></iframe>

    </div>
  
    
    <textarea id="notes" placeholder="Type your notes here..."></textarea>
   </div>



  </div>

  <canvas id="drawCanvas" aria-label="Drawing canvas"></canvas>

  <!-- Sidebar with icon buttons -->
  <div id="sidebar" title="Toolbar with drawing and upload tools" role="toolbar" aria-orientation="vertical">
    <button id="btn-draw" title="Draw (Pencil)" aria-pressed="false" aria-label="Toggle drawing tool">
      <!-- Pencil icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" 
           stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 20h9" />
        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" />
      </svg>
    </button>
    <button id="btn-erase" title="Eraser" aria-pressed="false" aria-label="Toggle eraser tool">
      <!-- Eraser icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" 
           stroke-linecap="round" stroke-linejoin="round">
        <path d="M16 16l4-4-8-8-4 4z" />
        <path d="M7 17l-3 3" />
        <path d="M14 10l-4 4" />
      </svg>
    </button>
    <button id="btn-img" title="Add Image from URL" aria-label="Add image from URL">
      <!-- Image icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" 
           stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
        <circle cx="8.5" cy="8.5" r="1.5"/>
        <path d="M21 15l-5-5L5 21"/>
      </svg>
    </button>
    <button id="btn-clear" title="Clear Drawing" aria-label="Clear drawing canvas">
      <!-- Clear icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" 
           stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
    <button id="btn-pdf" title="Set PDF URL" aria-label="Set PDF URL">
      <!-- PDF file icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
      </svg>
    </button>


     <!-- Upload icon -->
    <button id="btn-upload-device" title="Upload Image from Device" aria-label="Upload image from device">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" 
           stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
    </button>
    <input type="file" id="deviceImageInput" accept="image/*" style="display:none;" />

        <!-- Video upload button -->
    <button id="btn-video" title="Set Video URL" aria-label="Set Video URL">
      <!-- Video icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round">
        <polygon points="23 7 16 12 23 17 23 7"></polygon>
        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
      </svg>
    </button>
    

     <a href="saveNote.html" id="btn-ancient-logo" title="Ancient Sci-Fi Logo" aria-label="Ancient style logo button" style="background:none; border:none; padding:4px; cursor:pointer; text-decoration:none;">
      <svg
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        width="24"
        height="24"
        aria-hidden="true"
        focusable="false"
      >
        <!-- Outer square frame -->
        <rect x="2" y="2" width="20" height="20" />
        
        <!-- Inner circle -->
        <circle cx="12" cy="12" r="6" />
        
        <!-- Four "ancient rune" style marks -->
        <path d="M12 6 L12 9" />
        <path d="M12 15 L12 18" />
        <path d="M6 12 L9 12" />
        <path d="M15 12 L18 12" />
        
        <!-- Diagonal cross inside circle -->
        <line x1="8" y1="8" x2="16" y2="16" />
        <line x1="16" y1="8" x2="8" y2="16" />
      </svg>
    </a>

    <button id="wiki-assistant-toggle" title="Toggle Wiki Assistant">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 13v-2a8 8 0 0 1 16 0v2" />
        <path d="M18 19a2 2 0 0 0 2-2v-4" />
        <path d="M6 19a2 2 0 0 1-2-2v-4" />
        <path d="M12 23v-4" />
      </svg>
    </button>
    
    <!-- Wiki Assistant Panel -->
    <div id="wiki-assistant">
     <iframe src="wiki.html" title="Wiki Assistant"></iframe>
    </div>
    
     <button id="save-everything" style=" color: white; border: none; cursor: pointer;">üíæ</button>
     
     

  </div>
       <div id="toggle-panel" title="Toggle Wiki Panel">
    <svg viewBox="0 0 24 24">
      <path d="M12 2L15 8H9L12 2ZM2 22H22L12 13L2 22Z" />
    </svg>
  </div>

  <!-- Main wiki container -->
 
  <script>
    
    const drawBtn = document.getElementById('btn-draw');
    const eraseBtn = document.getElementById('btn-erase');
    const imgBtn = document.getElementById('btn-img');
    const clearBtn = document.getElementById('btn-clear');
    const pdfBtn = document.getElementById('btn-pdf');
    const videoBtn = document.getElementById('btn-video');

    const pdfViewer = document.getElementById('mediaViewer'); 

    const pdfContainer = document.getElementById('pdf-container');
    const notesArea = document.getElementById('notes');
    const canvas = document.getElementById('drawCanvas');
    const ctx = canvas.getContext('2d');
    const sidebar = document.getElementById('sidebar');
    const uploadDeviceBtn = document.getElementById('btn-upload-device');
    const deviceImageInput = document.getElementById('deviceImageInput');
   
        uploadDeviceBtn.onclick = () => {
          deviceImageInput.click();
        };
    
    deviceImageInput.onchange = (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.className = 'uploaded-img';
        img.style.top = '200px';
        img.style.left = '200px';
        img.style.position = 'absolute';
        img.style.width = '150px';
        img.style.height = 'auto';
        img.setAttribute('tabindex', '0');
        document.body.appendChild(img);
    
        const resizeHandle = document.createElement('div');
        resizeHandle.className = 'resize-handle';
        document.body.appendChild(resizeHandle);
    
        function updateResizeHandlePos() {
          const rect = img.getBoundingClientRect();
          resizeHandle.style.left = rect.right - 6 + 'px';
          resizeHandle.style.top = rect.bottom - 6 + 'px';
        }
    
            function selectImage() {
              document.querySelectorAll('img.uploaded-img.selected').forEach(i => {
                i.classList.remove('selected');
                const rh = i._resizeHandle;
                if(rh) rh.style.display = 'none';
              });
              img.classList.add('selected');
              resizeHandle.style.display = 'block';
              updateResizeHandlePos();
              img._resizeHandle = resizeHandle;
            }
        
            function deselectImage() {
              img.classList.remove('selected');
              resizeHandle.style.display = 'none';
            }
        
            img.addEventListener('click', (e) => {
              e.stopPropagation();
              selectImage();
            });
        
            document.body.addEventListener('click', (e) => {
              if (e.target !== img && e.target !== resizeHandle) {
                deselectImage();
              }
            });
        
            img.onmousedown = function (e) {
              if (!img.classList.contains('selected')) selectImage();
              e.preventDefault();
              let shiftX = e.clientX - img.getBoundingClientRect().left;
              let shiftY = e.clientY - img.getBoundingClientRect().top;
        
              function moveAt(pageX, pageY) {
                img.style.left = pageX - shiftX + 'px';
                img.style.top = pageY - shiftY + 'px';
                updateResizeHandlePos();
              }
        
              function onMouseMove(e) {
                moveAt(e.pageX, e.pageY);
              }
        
              document.addEventListener('mousemove', onMouseMove);
              document.addEventListener('mouseup', () => {
                document.removeEventListener('mousemove', onMouseMove);
              }, { once: true });
            };
        
            resizeHandle.onmousedown = function (e) {
              e.preventDefault();
              e.stopPropagation();
              let startX = e.clientX;
              let startY = e.clientY;
              const startWidth = img.offsetWidth;
              const startHeight = img.offsetHeight;
        
              function onMouseMove(e) {
                const newWidth = startWidth + (e.clientX - startX);
                const newHeight = startHeight + (e.clientY - startY);
                if (newWidth > 50) img.style.width = newWidth + 'px';
                if (newHeight > 50) img.style.height = newHeight + 'px';
                updateResizeHandlePos();
              }
        
              function onMouseUp() {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
              }
        
              document.addEventListener('mousemove', onMouseMove);
              document.addEventListener('mouseup', onMouseUp);
            };
        
            resizeHandle.style.display = 'none';
        
            window.addEventListener('keydown', (e) => {
              if (e.key === "Delete" && img.classList.contains('selected')) {
                resizeHandle.remove();
                img.remove();
              }
            });
          };
          reader.readAsDataURL(file);
        };
    // Timer elements
    const timerBtn = document.getElementById('timer-btn');
    const timerPopup = document.getElementById('timer-popup');
    const startTimerBtn = document.getElementById('start-timer');
    const pauseTimerBtn = document.getElementById('pause-timer');
    const resetTimerBtn = document.getElementById('reset-timer');
    const minutesInput = document.getElementById('minutes');
    const countdownDisplay = document.getElementById('countdown-display');
    const toggleBtn = document.getElementById('wiki-assistant-toggle');
    const assistant = document.getElementById('wiki-assistant');
  
    // Toggle visibility
    toggleBtn.addEventListener('click', () => {
      assistant.style.display = assistant.style.display === 'none' ? 'block' : 'none';
    });
  
    // Draggable functionality
    let isDragging = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
  
    assistant.addEventListener('mousedown', (e) => {
      if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A') return; // Don't drag if clicking buttons or links
      isDragging = true;
      dragOffsetX = e.clientX - assistant.offsetLeft;
      dragOffsetY = e.clientY - assistant.offsetTop;
      assistant.style.cursor = 'grabbing';
    });
  
    document.addEventListener('mouseup', () => {
      isDragging = false;
      assistant.style.cursor = 'move';
    });
  
    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        let newX = e.clientX - dragOffsetX;
        let newY = e.clientY - dragOffsetY;
  
        // Keep inside viewport horizontally
        newX = Math.max(0, Math.min(window.innerWidth - assistant.offsetWidth, newX));
        // Keep inside viewport vertically
        newY = Math.max(0, Math.min(window.innerHeight - assistant.offsetHeight, newY));
  
        assistant.style.left = newX + 'px';
        assistant.style.top = newY + 'px';
        assistant.style.right = 'auto'; // unset right to allow positioning by left
      }
    });

  // Start hidden
  assistant.style.display = 'none';
 
// üÜï --- SAVE EVERYTHING TO LOCAL STORAGE --- //
function saveAll() {
  // Save notes
  localStorage.setItem('studyNotes', notesArea.value);

  // Save PDF URL
  localStorage.setItem('pdfUrl', pdfViewer.src);

  // Save canvas drawing as image
  const drawingData = canvas.toDataURL();
  localStorage.setItem('drawingData', drawingData);

  // Save uploaded images (positions and src)
  const imageData = [];
  document.querySelectorAll('img.uploaded-img').forEach(img => {
    imageData.push({
      src: img.src,
      top: img.style.top,
      left: img.style.left,
      width: img.style.width,
      height: img.style.height
    });
  });
  localStorage.setItem('uploadedImages', JSON.stringify(imageData));

  // Visual feedback
  const saveBtn = document.getElementById('save-everything');
  saveBtn.textContent = "‚úÖ Saved!";
  setTimeout(() => saveBtn.textContent = "üíæ", 1500);
}

document.getElementById('save-everything').onclick = saveAll;

// üÜï --- LOAD DRAWING DATA --- //
window.addEventListener('load', () => {
  const drawingData = localStorage.getItem('drawingData');
  if (drawingData) {
    const img = new Image();
    img.onload = () => ctx.drawImage(img, 0, 0);
    img.src = drawingData;
  }

  // üÜï --- LOAD UPLOADED IMAGES --- //
  const imageData = JSON.parse(localStorage.getItem('uploadedImages') || '[]');
  imageData.forEach(data => {
    const img = document.createElement('img');
    img.src = data.src;
    img.className = 'uploaded-img';
    img.style.position = 'absolute';
    img.style.top = data.top;
    img.style.left = data.left;
    img.style.width = data.width;
    img.style.height = data.height;
    img.setAttribute('tabindex', '0');
    document.body.appendChild(img);

    const resizeHandle = document.createElement('div');
    resizeHandle.className = 'resize-handle';
    document.body.appendChild(resizeHandle);

    function updateResizeHandlePos() {
      const rect = img.getBoundingClientRect();
      resizeHandle.style.left = rect.right - 6 + 'px';
      resizeHandle.style.top = rect.bottom - 6 + 'px';
    }
    updateResizeHandlePos();

    function selectImage() {
      document.querySelectorAll('img.uploaded-img.selected').forEach(i => {
        i.classList.remove('selected');
        const rh = i._resizeHandle;
        if(rh) rh.style.display = 'none';
      });
      img.classList.add('selected');
      resizeHandle.style.display = 'block';
      updateResizeHandlePos();
      img._resizeHandle = resizeHandle;
    }

    function deselectImage() {
      img.classList.remove('selected');
      resizeHandle.style.display = 'none';
    }

    img.addEventListener('click', (e) => {
      e.stopPropagation();
      selectImage();
    });

    document.body.addEventListener('click', (e) => {
      if (e.target !== img && e.target !== resizeHandle) {
        deselectImage();
      }
    });

    img.onmousedown = function (e) {
      if (!img.classList.contains('selected')) selectImage();
      e.preventDefault();
      let shiftX = e.clientX - img.getBoundingClientRect().left;
      let shiftY = e.clientY - img.getBoundingClientRect().top;

      function moveAt(pageX, pageY) {
        img.style.left = pageX - shiftX + 'px';
        img.style.top = pageY - shiftY + 'px';
        updateResizeHandlePos();
      }

      function onMouseMove(e) {
        moveAt(e.pageX, e.pageY);
      }

      document.addEventListener('mousemove', onMouseMove);
      img.onmouseup = () => {
        document.removeEventListener('mousemove', onMouseMove);
        img.onmouseup = null;
      };
    };
    img.ondragstart = () => false;

    resizeHandle.onmousedown = function (e) {
      e.preventDefault();
      e.stopPropagation();
      let startX = e.clientX;
      let startY = e.clientY;
      const startWidth = img.offsetWidth;
      const startHeight = img.offsetHeight;

      function onMouseMove(e) {
        const newWidth = startWidth + (e.clientX - startX);
        const newHeight = startHeight + (e.clientY - startY);
        if (newWidth > 50) img.style.width = newWidth + 'px';
        if (newHeight > 50) img.style.height = newHeight + 'px';
        updateResizeHandlePos();
      }

      function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      }

      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    };

    resizeHandle.style.display = 'none';

    window.addEventListener('keydown', (e) => {
      if (e.key === "Delete" && img.classList.contains('selected')) {
        resizeHandle.remove();
        img.remove();
      }
    });
  });
});


    let timer = null;
    let timerSeconds = parseInt(minutesInput.value) * 60;
    let timerRunning = false;

    function updateCountdown() {
      let mins = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
      let secs = (timerSeconds % 60).toString().padStart(2, '0');
      countdownDisplay.textContent = `${mins}:${secs}`;
    }

    function startTimer() {
      if (timerRunning) return;
      timerRunning = true;
      timer = setInterval(() => {
        if (timerSeconds > 0) {
          timerSeconds--;
          updateCountdown();
        } else {
          clearInterval(timer);
          timerRunning = false;
          alert("‚è∞ Time's up!");
        }
      }, 1000);
    }
    function pauseTimer() {
      timerRunning = false;
      clearInterval(timer);
    }
    function resetTimer() {
      pauseTimer();
      timerSeconds = parseInt(minutesInput.value) * 60;
      updateCountdown();
    }

    timerBtn.onclick = () => {
      timerPopup.style.display = timerPopup.style.display === 'block' ? 'none' : 'block';
    };
    startTimerBtn.onclick = () => startTimer();
    pauseTimerBtn.onclick = () => pauseTimer();
    resetTimerBtn.onclick = () => resetTimer();
    minutesInput.onchange = () => {
      if (!timerRunning) {
        timerSeconds = parseInt(minutesInput.value) * 60;
        updateCountdown();
      }
    };
    updateCountdown();

    // Canvas resize & setup
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // Drawing state
    let drawing = false;
    let erasing = false;
    let lastX = 0;
    let lastY = 0;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.lineWidth = 3;
    ctx.strokeStyle = '#4caf50';

    // Clear drawing
    clearBtn.onclick = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    };

    // Tool toggles
    function deactivateAllTools() {
      drawBtn.classList.remove('active');
      eraseBtn.classList.remove('active');
      erasing = false;
      canvas.classList.remove('drawing-enabled');
      canvas.style.cursor = 'default';
      canvas.style.pointerEvents = 'none';
      canvas.style.zIndex = 1;
    }

    drawBtn.onclick = () => {
      if (drawBtn.classList.contains('active')) {
        deactivateAllTools();
      } else {
        deactivateAllTools();
        drawBtn.classList.add('active');
        erasing = false;
        canvas.classList.add('drawing-enabled');
        canvas.style.cursor = 'crosshair';
        canvas.style.pointerEvents = 'all';
        canvas.style.zIndex = 5;
        ctx.strokeStyle = '#4caf50';
        ctx.lineWidth = 3;
      }
    };

    eraseBtn.onclick = () => {
      if (eraseBtn.classList.contains('active')) {
        deactivateAllTools();
      } else {
        deactivateAllTools();
        eraseBtn.classList.add('active');
        erasing = true;
        canvas.classList.add('drawing-enabled');
        canvas.style.cursor = 'crosshair';
        canvas.style.pointerEvents = 'all';
        canvas.style.zIndex = 5;
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 10;
      }
    };

   pdfBtn.onclick = () => {
      const url = prompt("Enter PDF URL (must end with .pdf):");
      if (url) {
        const viewer = document.getElementById('mediaViewer');
        viewer.src = url;
        viewer.type = "application/pdf";
        localStorage.setItem('mediaType', 'pdf');
        localStorage.setItem('mediaUrl', url);
      }
    };
    
    videoBtn.onclick = () => {
      const url = prompt("Enter YouTube or video URL:");
      if (url) {
        let embedUrl = url;
    
        // Handle YouTube short or long links
        if (url.includes("youtube.com/watch?v=")) {
          const videoId = url.split("v=")[1].split("&")[0];
          embedUrl = `https://www.youtube.com/embed/${videoId}`;
        } else if (url.includes("youtu.be/")) {
          const videoId = url.split("youtu.be/")[1].split("?")[0];
          embedUrl = `https://www.youtube.com/embed/${videoId}`;
        }
    
        const viewer = document.getElementById('mediaViewer');
        viewer.src = embedUrl;
        viewer.type = "text/html";
        localStorage.setItem('mediaType', 'video');
        localStorage.setItem('mediaUrl', embedUrl);
      }
    };

    // Drawing events
    canvas.onmousedown = (e) => {
      if (!canvas.classList.contains('drawing-enabled')) return;
      drawing = true;
      lastX = e.clientX;
      lastY = e.clientY;
    };
    canvas.onmouseup = () => {
      drawing = false;
    };
    canvas.onmouseout = () => {
      drawing = false;
    };
    canvas.onmousemove = (e) => {
      if (!drawing) return;
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(e.clientX, e.clientY);
      ctx.stroke();
      lastX = e.clientX;
      lastY = e.clientY;
    };

    // Image upload (URL) + drag/resize/delete
    imgBtn.onclick = () => {
      const url = prompt("Enter image URL:");
      if (!url) return;
      const img = document.createElement('img');
      img.src = url;
      img.className = 'uploaded-img';
      img.style.top = '150px';
      img.style.left = '150px';
      img.style.position = 'absolute';
      img.style.width = '150px';
      img.style.height = 'auto';
      img.setAttribute('tabindex', '0'); // keyboard focusable for accessibility
      document.body.appendChild(img);

      // Create resize handle
      const resizeHandle = document.createElement('div');
      resizeHandle.className = 'resize-handle';
      document.body.appendChild(resizeHandle);

      // Position resize handle relative to image
      function updateResizeHandlePos() {
        const rect = img.getBoundingClientRect();
        resizeHandle.style.left = rect.right - 6 + 'px';
        resizeHandle.style.top = rect.bottom - 6 + 'px';
      }




      updateResizeHandlePos();

      // Select image & show resize handle
      function selectImage() {
        // Deselect all other images
        document.querySelectorAll('img.uploaded-img.selected').forEach(i => {
          i.classList.remove('selected');
          const rh = i._resizeHandle;
          if(rh) rh.style.display = 'none';
        });
        img.classList.add('selected');
        resizeHandle.style.display = 'block';
        updateResizeHandlePos();
        img._resizeHandle = resizeHandle; // store ref
      }

      function deselectImage() {
        img.classList.remove('selected');
        resizeHandle.style.display = 'none';
      }

      img.addEventListener('click', (e) => {
        e.stopPropagation();
        selectImage();
      });

      // Clicking outside deselects
      document.body.addEventListener('click', (e) => {
        if (e.target !== img && e.target !== resizeHandle) {
          deselectImage();
        }
      });

      // Drag image
      img.onmousedown = function (e) {
        if (!img.classList.contains('selected')) selectImage();
        e.preventDefault();
      
        let shiftX = e.clientX - img.getBoundingClientRect().left;
        let shiftY = e.clientY - img.getBoundingClientRect().top;
      
        function moveAt(pageX, pageY) {
          img.style.left = pageX - shiftX + 'px';
          img.style.top = pageY - shiftY + 'px';
          updateResizeHandlePos();
        }
      
        function onMouseMove(e) {
          moveAt(e.pageX, e.pageY);
        }
      
        function onMouseUp() {
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        }
      
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      };

      img.ondragstart = () => false;

      // Resize image with handle
      resizeHandle.onmousedown = function (e) {
        e.preventDefault();
        e.stopPropagation();
        let startX = e.clientX;
        let startY = e.clientY;
        const startWidth = img.offsetWidth;
        const startHeight = img.offsetHeight;

        function onMouseMove(e) {
          const newWidth = startWidth + (e.clientX - startX);
          const newHeight = startHeight + (e.clientY - startY);
          if (newWidth > 50) img.style.width = newWidth + 'px';
          if (newHeight > 50) img.style.height = newHeight + 'px';
          updateResizeHandlePos();
        }

        function onMouseUp() {
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      };

      // Hide resize handle initially
      resizeHandle.style.display = 'none';

      // Delete image on Delete key if selected
      window.addEventListener('keydown', (e) => {
        if (e.key === "Delete" && img.classList.contains('selected')) {
          resizeHandle.remove();
          img.remove();
        }
      });
    };

    // Save notes to localStorage automatically every 10 seconds
    notesArea.value = localStorage.getItem('studyNotes') || '';
    notesArea.addEventListener('input', () => {
      localStorage.setItem('studyNotes', notesArea.value);
    });

    setInterval(() => {
      localStorage.setItem('studyNotes', notesArea.value);
    }, 10000);

    // Load PDF from last saved url
    const mediaViewer = document.getElementById('mediaViewer');
    const savedType = localStorage.getItem('mediaType');
    const savedUrl = localStorage.getItem('mediaUrl');
    
    if (savedUrl) {
      mediaViewer.src = savedUrl;
      if (savedType === 'pdf') {
        mediaViewer.type = 'application/pdf';
      } else {
        mediaViewer.type = 'text/html';
      }
    }


    // Save pdf url on set
    pdfBtn.onclick = () => {
      const url = prompt("Enter URL:");
      if (url) {
        pdfViewer.src = url;
        localStorage.setItem('mediaUrl', url);
      }
    };


  </script>
</body>
</html>
